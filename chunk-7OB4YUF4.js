import{Q as S,Xb as c,ia as i}from"./chunk-X3DYNEO4.js";import{a as u,b as l}from"./chunk-JHI3MBHO.js";function h(s){return[2,3,4].includes(s+1)}function b(s,t,r){if(!s.has(t)){let e=r();return s.set(t,e),e}return s.get(t)}function p(s,t){if(!t.length)return;let r=Object.keys(t[0]),e=[r.join(","),...t.map(m=>r.map(d=>JSON.stringify(m[d]??"")).join(","))].join(`
`),n=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),a=document.createElement("a");a.href=o,a.setAttribute("download",s),document.body.appendChild(a),a.click(),document.body.removeChild(a)}var g=class s{playerStats=i(new Map);gameState=i({homeScore:0,awayScore:0,currentServer:"home",currentSet:0,homeSetsWon:0,awaySetsWon:0,rotation:Array(6).fill(null)});redoStack=i([]);homeSiteRight=i(!1);previousSets=i([]);setHistory=i([]);correctModeActive=i(!1);matchTime=i(0);timerInterval=null;matchStatus=i("notStarted");started=c(()=>this.matchStatus()==="inProgress");paused=c(()=>this.matchStatus()==="paused");notStarted=c(()=>this.matchStatus()==="notStarted");isHomeRightSide=c(()=>this.homeSiteRight());currentServer=c(()=>this.gameState().currentServer);currentSet=c(()=>this.gameState().currentSet);currentRotation=c(()=>this.gameState().rotation||[]);startMatch(){if(!this.started()){if(this.gameState().rotation.find(t=>t===null)!==void 0){alert("Please set all player positions before starting the match.");return}this.matchStatus.set("inProgress"),this.timerInterval=setInterval(()=>{this.matchTime.update(t=>t+1)},1e3)}}pauseMatch(){this.started()&&(this.matchStatus.set("paused"),this.timerInterval&&clearInterval(this.timerInterval))}stopMatch(){this.matchStatus.set("notStarted"),this.timerInterval&&clearInterval(this.timerInterval),this.matchTime.set(0)}changeSides(){this.homeSiteRight.update(t=>!t)}changeServiceTeam(){this.started()&&!this.correctModeActive()||this.gameState.update(t=>l(u({},t),{currentServer:t.currentServer==="home"?"away":"home"}))}updateSetPoints(t,r=null){let e=this.gameState();if(this.started()&&!r){this.setHistory.update(a=>[...a,structuredClone(this.gameState())]),this.redoStack.set([]);let n=e.currentServer!==t&&t=="home";e=l(u({},e),{homeScore:t=="home"?e.homeScore+1:e.homeScore,awayScore:t=="away"?e.awayScore+1:e.awayScore,currentServer:t});let o=e.homeScore-e.awayScore;if(this.gameState.set(e),Math.abs(o)>=2&&(e.homeScore>=25||e.awayScore>=25)){let a=o>0,d={homeScore:0,awayScore:0,currentServer:this.setHistory()[0].currentServer==="home"?"away":"home",currentSet:this.currentSet()+1,homeSetsWon:a?e.homeSetsWon+1:e.homeSetsWon,awaySetsWon:a?e.awaySetsWon:e.awaySetsWon+1,rotation:Array(6).fill(null)};this.previousSets.update(y=>[...y,structuredClone(this.setHistory())]),this.stopMatch(),this.gameState.set(d)}n&&this.rotate()}else this.correctModeActive()&&r&&(e=l(u({},e),{homeScore:t=="home"?e.homeScore+r:e.homeScore,awayScore:t=="away"?e.awayScore+r:e.awayScore}),this.gameState.set(e))}undo(){if(this.started()&&this.setHistory().length>1){let t=structuredClone(this.gameState());this.redoStack.update(e=>[...e,t]);let r=this.setHistory().pop();if(!r)return;this.gameState.set(r)}}redo(){if(this.started()&&this.redoStack().length>0){let t=structuredClone(this.gameState());this.setHistory.update(e=>[...e,t]);let r=this.redoStack().pop();if(!r)return;this.gameState.set(r)}}setPlayer(t,r){if(this.notStarted()){if(t.position=="Libero"){alert("Please set the libero position after the match has started.");return}let e=[...this.currentRotation()],n=e.findIndex(o=>o?.number===t.number);n!==-1&&(e[n]=null),e[r]=t,this.updateRotation(e)}else if(this.started()){if(this.correctModeActive()){if(t.position=="Libero"&&h(r))return;let e=[...this.currentRotation()];if(e.find(a=>a?.position=="Libero"))return;let o=e.findIndex(a=>a?.number===t.number);o!==-1&&(e[o]=null),e[r]=t,this.updateRotation(e,!0);return}if(t.position=="Libero"){if(h(r))return;let e=[...this.currentRotation()];if(e.find(a=>a?.position=="Libero"))return;let o=e[r];if(o){if(o.position=="Libero")return;t.playerChangedFor=o,e[r]=t,this.updateRotation(e)}}else{let e=[...this.currentRotation()],n=e[r];n&&(n.playerChangedFor?t.number!==n.playerChangedFor.number?alert("This position can only be changed back to the original player. Player "+n.playerChangedFor.number):(e[r]=n.playerChangedFor,n.playerChangedFor=void 0,this.updateRotation(e)):(e[r]=t,t.playerChangedFor=n,this.updateRotation(e)))}}}updateRotation(t,r=!1){r||this.setHistory.update(e=>[...e,structuredClone(this.gameState())]),this.gameState.update(e=>l(u({},e),{rotation:t})),console.log(this.gameState())}rotate(){let t=this.gameState();if(!t.rotation||t.rotation.length===0)return;let r=[...t.rotation],e=r.shift(),n=[...r,e],o=n.findIndex(a=>a?.position=="Libero");if(o!==-1){let a=n[o];a.playerChangedFor&&h(o)&&(n[o]=a.playerChangedFor,a.playerChangedFor=void 0,alert("Libero "+a.number+" was exchanged for Player "+n[o]?.number))}this.gameState.update(a=>l(u({},a),{rotation:n}))}constructor(){}recordPlayerAction(t,r){let e=1;this.correctModeActive()&&(e=-1);let n=this.playerStats(),o=b(n,r.number,()=>({playerNumber:r.number,playerName:r.name,hits:0,kills:0,attackErrors:0,blocks:0,aces:0,serveErrors:0}));switch(t){case"hit":o.hits+=e;break;case"kill":o.kills+=e;break;case"attackError":o.attackErrors+=e;break;case"block":o.blocks+=e;break;case"serveError":o.serveErrors+=e;break;case"ace":o.aces+=e;break}this.playerStats.update(a=>(a.set(r.number,o),a))}formattedTime(){let t=this.matchTime(),r=Math.floor(t/60).toString().padStart(2,"0"),e=(t%60).toString().padStart(2,"0");return`${r}:${e}`}exportPlayerStatsCsv(){let r=Array.from(this.playerStats().values()).map(e=>({playerNumber:e.playerNumber,playerName:e.playerName,hits:e.hits,kills:e.kills,attackErrors:e.attackErrors,blocks:e.blocks,aces:e.aces,serveErrors:e.serveErrors}));p("player-stats.csv",r)}reset(){this.setHistory.set([]),this.gameState.set({homeScore:0,awayScore:0,currentServer:"home",currentSet:1,homeSetsWon:0,awaySetsWon:0,rotation:Array(6).fill(null)}),this.matchStatus.set("notStarted"),this.playerStats.set(new Map),this.previousSets.set([]),this.matchTime.set(0),this.timerInterval&&clearInterval(this.timerInterval)}static \u0275fac=function(r){return new(r||s)};static \u0275prov=S({token:s,factory:s.\u0275fac,providedIn:"root"})};export{h as a,g as b};
